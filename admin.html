<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
  <!-- Favicon -->
  <link rel="icon" sizes="192x192" href="images/favicon.ico" />
  <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />


    
    <script src="assets/js/mainFlow.js"></script>
    <!-- Custom Stylesheet 
    <link rel="stylesheet" href="styles.css">
-->
<style>
    /* Universal Reset and Body Styling */
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f0f3f8;
        color: #333;
        line-height: 1.6;
    }
    
    .container {
        width: 90%;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    h1, h2, h3 {
        color: #00509e;
        margin-bottom: 20px;
    }

    /* Header Styling */
    header {
        background-color: #0056b3;
        color: #fff;
        padding: 15px 0;
        text-align: center;
    }

    header nav ul {
        list-style: none;
    }

    header nav ul li {
        display: inline;
        margin: 0 15px;
    }

    header nav ul li a {
        color: #fff;
        text-decoration: none;
        font-weight: bold;
    }

    /* Login Section */
    #login-section, #admin-dashboard {
        width: 100%;
        margin: 20px auto;
        padding: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        text-align: center;
    }
    
    #google-login-btn {
        background-color: #4285F4;
        color: white;
        padding: 12px 20px;
        font-size: 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    #google-login-btn:hover {
        background-color: #357AE8;
    }

    /* Dashboard Buttons */
    #admin-dashboard button {
        background-color: #00a65a;
        color: white;
        padding: 12px 25px;
        margin: 10px;
        font-size: 1rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    #admin-dashboard button:hover {
        background-color: #008d4c;
    }

    /* Table Styling */
    table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
        background: #fff;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    th, td {
        padding: 14px;
        text-align: center;
    }

    th {
        background-color: #0056b3;
        color: white;
        font-weight: bold;
    }

    td {
        background-color: #f9f9f9;
        border-bottom: 1px solid #ddd;
    }

    tr:nth-child(even) td {
        background-color: #f1f5f8;
    }

    /* Interactive Sections */
    #analytics-section, #contact-messages {
        display: none;
    }

    /* Footer Style */
    footer {
        text-align: center;
        padding: 10px;
        font-size: 0.9rem;
        color: #666;
        background: #e2eaf3;
    }











    .details-container {
    background: #f9f9f9;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    margin-top: 5px;
}

.session-entry {
    margin-bottom: 10px;
    font-size: 14px;
}

.toggle-details {
    cursor: pointer;
    padding: 5px 10px;
    border: none;
    background: #007bff;
    color: white;
    border-radius: 4px;
}

.toggle-details:hover {
    background: #0056b3;
}

</style>

</head>





    <body>
<!-- Header Section -->
<header id="header">



    <!-- Main Navigation Section with Detailed Titles and ARIA Labels -->
    <nav aria-label="Main Site Navigation">
        <ul class="main-nav">
            <li><a href="https://rw-501.github.io/Portfolio/#about" title="Learn More About Ronald Wilson II">About Me</a></li>
            <li><a href="https://rw-501.github.io/Portfolio/#work" title="View My Portfolio Projects">Projects</a></li>
            <li><a href="https://rw-501.github.io/Portfolio/#bizz" title="Explore My Business Ventures">Business</a></li>
            <li><a href="https://www.linkedin.com/in/lrpinc/" title="Connect with Ronald Wilson II on LinkedIn">LinkedIn</a></li>
            <li><a href="https://rw-501.github.io/Portfolio/#projects" title="Explore Ongoing Projects by Ronald Wilson II">Active Projects</a></li>
        </ul>
    </nav>
</header>

    <!-- Login Section -->
    <div id="login-section">
        <h2>Admin Login</h2>
        <button id="google-login-btn">Login with Google</button>
    </div>

    <!-- Admin Dashboard Section -->
    <div id="admin-dashboard" style="display:none;">
        <h2>Admin Dashboard</h2>
        <p>Welcome, <span id="admin-name"></span></p>

        <button id="updateDataBtn">Update Data</button>

        <div>
            <button id="view-analytics-btn">View Analytics</button>
            <button id="read-contact-btn">Read Contact Messages</button>
            <button id="Guestbook-btn">Guestbook Messages</button>

            <button id="manage-social-media-btn">Manage Social Media</button>
            <button id="manage-websites-btn">Manage Websites</button>
        </div>

        <div id="analytics-section" class="views">
            <h3>Analytics Data</h3>
        
            <label for="sortBy">Sort By:</label>
            <select id="sortBy">
                <option value="date">Date</option>
                <option value="timeOnPage">Time on Page</option>
                <option value="location">Location</option>
            </select>
        
            <label for="filterDevice">Filter by Device:</label>
            <select id="filterDevice">
                <option value="all">All</option>
                <option value="mobile">Mobile</option>
                <option value="desktop">Desktop</option>
            </select>
        
            <button id="refreshAnalytics">Update Data</button>
        
            <table id="analyticsTable">
                <thead>
                    <tr>
                        <th>IP Address</th>
                        <th>Guest Name</th>
                        <th>Guestbook Message</th>
                        <th>Contact Message</th>
                        <th>Location</th>
                        <th>Page Views</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="analyticsTableBody"></tbody>
            </table>
        </div>
        

        <!-- Contact Messages Section -->
        <div id="contact-messages" class="views" >
            <h3>Contact Messages</h3>
            <table id="contactTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Message</th>
                        <th>Timestamp</th>
                    </tr>
                </thead>
                <tbody  id="contactTableBody">
                </tbody>
            </table>
        </div>
    </div>


        <!-- Guestbook Messages Section -->
        <div id="Guestbook-messages" class="views" >
            <h3>Contact Messages</h3>
            <table id="GuestbookTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Message</th>
                        <th>Timestamp</th>
                        <th>UserIP</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody  id="GuestbookTableBody">
                </tbody>
            </table>
        </div>
    </div>


    <!-- Firebase Scripts (using Firebase v9) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-analytics.js";
    
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCsitF_YPDGnMwK0xIk2tUgQXJnxS2HN_o",
            authDomain: "ron-main.firebaseapp.com",
            projectId: "ron-main",
            storageBucket: "ron-main.appspot.com",
            messagingSenderId: "885898378176",
            appId: "1:885898378176:web:ee850a5c980b4417a2a625",
            measurementId: "G-Y16GN7VL5Q"
        };
    
        // Initialize Firebase and services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);


        import { } from "https://rw-501.github.io/Portfolio/assets/js/mainFlow-live.js";



    // Function to check login state on page load
function checkLoginStatus() {
    const userData = JSON.parse(localStorage.getItem('userData'));

    if (userData && userData.email === '1988lrp@gmail.com') {
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('admin-dashboard').style.display = 'block';
        document.getElementById('admin-name').textContent = userData.name;
    } else {
        document.getElementById('login-section').style.display = 'block';
        document.getElementById('admin-dashboard').style.display = 'none';
    }
}

// Run this function when the page loads
document.addEventListener("DOMContentLoaded", checkLoginStatus);

// Google Sign-In
const googleLoginBtn = document.getElementById('google-login-btn');
googleLoginBtn.addEventListener('click', async () => {
    const provider = new GoogleAuthProvider();
    try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;

        if (user.email === '1988lrp@gmail.com') {
            // Save user data to Local Storage
            localStorage.setItem('userData', JSON.stringify({
                name: user.displayName,
                email: user.email
            }));

            document.getElementById('login-section').style.display = 'none';
            document.getElementById('admin-dashboard').style.display = 'block';
            document.getElementById('admin-name').textContent = user.displayName;
        } else {
            alert('Unauthorized Email');
            await signOut(auth);
        }
    } catch (error) {
        console.error("Google Sign-In Error:", error);
    }
});

// Logout function
function logout() {
    signOut(auth).then(() => {
        // Clear Local Storage
        localStorage.removeItem('userData');

        // Hide Admin Dashboard, Show Login
        document.getElementById('admin-dashboard').style.display = 'none';
        document.getElementById('login-section').style.display = 'block';
    }).catch(error => {
        console.error("Error signing out:", error);
    });
}

async function fetchDataWithCache(cacheKey, fetchFunction) {
    const cachedData = localStorage.getItem(cacheKey);

    if (cachedData) {
        console.log(`Loaded ${cacheKey} from cache.`);
        return JSON.parse(cachedData);
    }

    const freshData = await fetchFunction();
    localStorage.setItem(cacheKey, JSON.stringify(freshData));
    return freshData;
}

function clearCache() {
    localStorage.removeItem("analyticsData");
    localStorage.removeItem("guestbookData");
    localStorage.removeItem("contactData");
    showToast("Cache Cleared! Fetching new data...", "info");
}

  // Fetch Analytics Data
  async function fetchAnalytics() {
    return new Promise(async (resolve) => {
        const logsTableBody = document.getElementById("analyticsTableBody");
        logsTableBody.innerHTML = "";

        const querySnapshot = await getDocs(collection(db, "portfolioAnalytics"));
        let analyticsData = [];
        let groupedData = {};

        const guestbookData = await fetchDataWithCache("guestbookData", fetchGuestbookMessages);
        const contactData = await fetchDataWithCache("contactData", fetchContactMessages);

        // Group data by IP
        querySnapshot.forEach(doc => {
            const data = doc.data();
            const userIP = data.ipAddress;
            let guestName = data.guestName || null;

            if (!groupedData[userIP]) {
                groupedData[userIP] = {
                    guestName: "Visitor",
                    guestbookMessage: "None",
                    contactMessage: "None",
                    location: "N/A",
                    pageViews: 0,
                    viewedEntries: []
                };
            }

            // Match Guestbook Messages
            const guestbookEntry = guestbookData.find(entry => entry.userIP === userIP);
            if (guestbookEntry) {
                groupedData[userIP].guestbookMessage = guestbookEntry.message;
                groupedData[userIP].guestName = guestbookEntry.name || groupedData[userIP].guestName;
            }

            // Match Contact Messages
            const contactEntry = contactData.find(entry => entry.userIP === userIP);
            if (contactEntry) {
                groupedData[userIP].contactMessage = contactEntry.message;
                groupedData[userIP].guestName = contactEntry.name || groupedData[userIP].guestName;
            }

            // Process each viewed entry
            data.viewed.forEach(entry => {
                groupedData[userIP].pageViews++;
                groupedData[userIP].viewedEntries.push(entry);
                groupedData[userIP].location = entry.location ? 
                    `${entry.location.city || 'Unknown'}, ${entry.location.state || 'Unknown'}, ${entry.location.country || 'Unknown'}` 
                    : "N/A";
            });
        });

        // Generate table rows
        Object.keys(groupedData).forEach(userIP => {
            const data = groupedData[userIP];
            const mainRow = document.createElement("tr");

            mainRow.innerHTML = `
                <td>${userIP}</td>
                <td>${data.guestName}</td>
                <td>${data.guestbookMessage}</td>
                <td>${data.contactMessage}</td>
                <td>${data.location}</td>
                <td>${data.pageViews}</td>
                <td>
                    <button class="toggle-details" data-ip="${userIP}">Show Details</button>
                </td>
            `;

            logsTableBody.appendChild(mainRow);

            // Create hidden details row
            const detailsRow = document.createElement("tr");
            detailsRow.innerHTML = `
                <td colspan="7">
                    <div class="details-container" id="details-${userIP}" style="display: none;">
                        ${data.viewedEntries.map(entry => `
                            <div class="session-entry">
                                <strong>Page:</strong> ${entry.page || "N/A"} <br>
                                <strong>Time on Page:</strong> ${entry.timeOnPage.toFixed(2) || "0"}s <br>
                                <strong>Device:</strong> ${entry.deviceType || "N/A"} <br>
                                <strong>Browser:</strong> ${entry.browser || "N/A"} <br>
                                <strong>Referral:</strong> ${entry.referral || "Direct"} <br>
                                <strong>Screen Resolution:</strong> ${entry.screenWidth}x${entry.screenHeight} <br>
                            </div>
                        `).join("<hr>")}
                    </div>
                </td>
            `;

            logsTableBody.appendChild(detailsRow);
            analyticsData.push(data);
        });

        // Attach event listeners to toggle details
        document.querySelectorAll(".toggle-details").forEach(button => {
            button.addEventListener("click", (e) => {
                const ip = e.target.getAttribute("data-ip");
                const detailsDiv = document.getElementById(`details-${ip}`);
                if (detailsDiv.style.display === "none") {
                    detailsDiv.style.display = "block";
                    e.target.textContent = "Hide Details";
                } else {
                    detailsDiv.style.display = "none";
                    e.target.textContent = "Show Details";
                }
            });
        });

        localStorage.setItem("analyticsData", JSON.stringify(analyticsData));
        resolve(analyticsData);
    });
}


function categorizeTime(dateString) {
    if (!dateString) return "Unknown";

    const dateParts = dateString.split("/");
    const currentDate = new Date(`${dateParts[2]}-${dateParts[0]}-${dateParts[1]}`);
    const hours = currentDate.getHours();

    if (hours >= 5 && hours < 12) return "Morning";
    if (hours >= 12 && hours < 17) return "Afternoon";
    if (hours >= 17 && hours < 21) return "Evening";
    return "Night";
}

document.getElementById("sortBy").addEventListener("change", (event) => {
    let analyticsData = JSON.parse(localStorage.getItem("analyticsData")) || [];
    const sortBy = event.target.value;

    analyticsData.sort((a, b) => {
        if (sortBy === "date") {
            return new Date(a.currentDate) - new Date(b.currentDate);
        } else if (sortBy === "timeOnPage") {
            return b.timeOnPage - a.timeOnPage;
        } else if (sortBy === "location") {
            return (a.location?.city || "").localeCompare(b.location?.city || "");
        }
    });

    renderAnalyticsTable(analyticsData);
});

document.getElementById("filterDevice").addEventListener("change", (event) => {
    let analyticsData = JSON.parse(localStorage.getItem("analyticsData")) || [];
    const filterBy = event.target.value;

    if (filterBy !== "all") {
        analyticsData = analyticsData.filter(entry => entry.deviceType === filterBy);
    }

    renderAnalyticsTable(analyticsData);
});

function renderAnalyticsTable(analyticsData) {
    const logsTableBody = document.getElementById("analyticsTableBody");
    logsTableBody.innerHTML = "";

    analyticsData.forEach(data => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${data.ipAddress || "N/A"}</td>
            <td>${data.guestName}</td>
            <td>${data.guestbookMessage}</td>
            <td>${data.contactMessage}</td>
            <td>${data.location ? `${data.location.city || 'Unknown'}, ${data.location.state || 'Unknown'}, ${data.location.country || 'Unknown'}` : "N/A"}</td>
            <td>${data.timeCategory}</td>
            <td>${data.pageViews}</td>
            <td>${data.timeOnPage.toFixed(2) || "0"}</td>
            <td>${data.deviceType || "N/A"}</td>
            <td>${data.browser || "N/A"}</td>
            <td>${data.referral || "Direct"}</td>
        `;
        logsTableBody.appendChild(row);
    });
}




document.getElementById("refreshAnalytics").addEventListener("click", async () => {
    localStorage.removeItem("analyticsData");
    await fetchAnalytics();
    showToast("Analytics data updated!", "success");
});






async function fetchGuestbookMessages() {
    return new Promise(async (resolve) => {
        const GuestbookTable = document.getElementById("GuestbookTableBody");
        GuestbookTable.innerHTML = "";

        const querySnapshot = await getDocs(collection(db, "Guestbook"));
        let guestbookData = [];

        querySnapshot.forEach(doc => {
            const data = doc.data();
            guestbookData.push({ ...data, id: doc.id });

            const mainRow = GuestbookTable.insertRow();
            mainRow.innerHTML = `
                <td>${data.name}</td>
                <td>${data.message}</td>
                <td>${data.timestamp.toDate().toLocaleString()}</td>
                <td>${data.userIP}</td>
                <td>
                    <select class="status-dropdown" data-id="${doc.id}">
                        <option value="active" ${data.status === 'active' ? 'selected' : ''}>Active</option>
                        <option value="pending" ${data.status === 'pending' ? 'selected' : ''}>Pending</option>
                        <option value="archived" ${data.status === 'archived' ? 'selected' : ''}>Archived</option>
                    </select>
                </td>
            `;
        });

        localStorage.setItem("guestbookData", JSON.stringify(guestbookData));
        resolve(guestbookData);
    });



    // Attach event listeners to all dropdowns
    document.querySelectorAll('.status-dropdown').forEach(select => {
        select.addEventListener('change', async (event) => {
            const newStatus = event.target.value;
            const docId = event.target.getAttribute('data-id');

            try {
                await updateDoc(doc(db, 'Guestbook', docId), { status: newStatus });
                showToast(`Status updated to: ${newStatus}`, "success");
            } catch (error) {
                console.error("Error updating status:", error);
                showToast("Failed to update status", "error");
            }
        });
    });
}

// Fetch Contact Messages
async function fetchContactMessages() {
    return new Promise(async (resolve) => {
        const contactTable = document.getElementById("contactTableBody");
        contactTable.innerHTML = "";

        const querySnapshot = await getDocs(collection(db, "portfolioContact"));
        let contactData = [];

        querySnapshot.forEach(doc => {
            const data = doc.data();
            contactData.push({ ...data, id: doc.id });

            const mainRow = contactTable.insertRow();
            mainRow.innerHTML = `
                <td>${data.name}</td>
                <td>${data.email}</td>
                <td>${data.message}</td>
                <td>${data.currentDate}</td>
                <td>
                    <select class="status-dropdown" data-id="${doc.id}">
                        <option value="unread" ${data.status === 'unread' ? 'selected' : ''}>Unread</option>
                        <option value="read" ${data.status === 'read' ? 'selected' : ''}>Read</option>
                        <option value="resolved" ${data.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                    </select>
                </td>
            `;

            if (Array.isArray(data.location)) {

const area = document.createElement("div");

data.location.forEach((entry) => {
    const row = document.createElement("tr");

    row.innerHTML = `
        <td>${entry.city || "N/A"}</td>
        <td>${entry.state || "N/A"}</td>
        <td>${entry.zip || "N/A"}</td>
        <td>${entry.country || "N/A"}</td>
        <td>${entry.location ? `${entry.location.city || 'Unknown'}, ${entry.location.state || 'Unknown'}, ${entry.location.country || 'Unknown'}` : "N/A"}</td>
    `;

    area.appendChild(row);
});
mainRow.appendChild(area);
            }



        });

        localStorage.setItem("contactData", JSON.stringify(contactData));
        resolve(contactData);
    });



    // Attach event listeners to all dropdowns
    document.querySelectorAll('.status-dropdown').forEach(select => {
        select.addEventListener('change', async (event) => {
            const newStatus = event.target.value;
            const docId = event.target.getAttribute('data-id');

            try {
                await updateDoc(doc(db, 'portfolioContact', docId), { status: newStatus });
                showToast(`Status updated to: ${newStatus}`, "success");
            } catch (error) {
                console.error("Error updating status:", error);
                showToast("Failed to update status", "error");
            }
        });
    });
}

// Function to hide all elements with the class "views"
function hideAllViews() {
    document.querySelectorAll('.views').forEach(view => {
        view.style.display = 'none';
    });
}

// Event Listeners to show specific sections
document.getElementById('view-analytics-btn').addEventListener('click', () => {
    hideAllViews(); // Hide all "views" sections
    document.getElementById('analytics-section').style.display = 'block';
    fetchAnalytics();
});

document.getElementById('read-contact-btn').addEventListener('click', () => {
    hideAllViews();
    document.getElementById('contact-messages').style.display = 'block';
    fetchContactMessages();
});

document.getElementById('Guestbook-btn').addEventListener('click', () => {
    hideAllViews();
    document.getElementById('Guestbook-messages').style.display = 'block';
    fetchGuestbookMessages();
});




document.getElementById("updateDataBtn").addEventListener("click", async () => {
    clearCache();
    await fetchAnalytics();
    await fetchGuestbookMessages();
    await fetchContactMessages();
});


   


   // JavaScript functions for handling website actions
   function updateWebsite(websiteId) {
        const status = document.getElementById(`status-${websiteId}`).value;
        const keywords = document.getElementById(`keywords-${websiteId}`).value;
        alert(`Updated ${websiteId}: Status - ${status}, Keywords - ${keywords}`);
        
        // AJAX request to update the status and keywords in the database
    }

    function deleteWebsite(websiteId) {
        if (confirm(`Are you sure you want to delete ${websiteId}?`)) {
            alert(`Deleted ${websiteId}`);
            
            // AJAX request to delete the website from the database
        }
    }


    
</script>



</body>

</html>
